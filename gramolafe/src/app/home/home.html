<div class="home">
  <div class="home-container">

    <header class="home-header">
      <div class="brand">
        üéµ <span>Gramola</span> Manager
      </div>
      <button class="logout-btn" (click)="logout()">
        Cerrar sesi√≥n
      </button>
    </header>

    <div class="card" *ngIf="!showingSettings">
      <h2 class="welcome">Hola, {{ barName }} üëã</h2>
      <p class="subtitle">Gestiona la m√∫sica de tu local</p>

      <div class="search">
        <input type="text" [(ngModel)]="query" placeholder="Buscar canci√≥n o artista‚Ä¶" (keyup.enter)="search()" />
        <button class="btn-primary" (click)="search()">Buscar</button>
      </div>

      <div class="view-switch">
        <button class="tab-btn" [class.active]="!showingPlaylist" (click)="showingPlaylist = false">Resultados</button>
        <button class="tab-btn" [class.active]="showingPlaylist" (click)="openPlaylist()">Mi playlist ({{ playlist.length }})</button>
      </div>

      <div *ngIf="tracks.length > 0 && !showingPlaylist">
        <h3 class="section-title">Resultados</h3>
        <div *ngFor="let item of tracks">
          <div class="track">
            <img *ngIf="item.album && item.album.images && item.album.images.length > 0" [src]="item.album.images[0].url" alt="cover"/>
            <div class="track-info">
              <div class="track-name">{{ item.name }}</div>
              <div class="track-artist" *ngIf="item.artists && item.artists.length > 0">{{ item.artists[0].name }}</div>
            </div>
            <button class="add-btn" (click)="preAdd(item)">A√±adir</button>
          </div>
        </div>
      </div>

      <div *ngIf="showingPlaylist">
        <h3 class="section-title">Cola de reproducci√≥n</h3>
        <p style="color:#6b7280; font-size:0.9rem; margin-bottom:15px;">
          ‚ÑπÔ∏è Esta m√∫sica suena en la App de Spotify del local.
        </p>

        <div class="section-grid">
          <div class="section-card nowplaying-card">
            <h4>Ahora sonando</h4>
            <div *ngIf="currentPlayback && currentPlayback.item; else noNow" class="now-playing">
              <div class="track">
                <img *ngIf="currentPlayback.item.album && currentPlayback.item.album.images && currentPlayback.item.album.images.length>0" [src]="currentPlayback.item.album.images[0].url" />
                <div class="track-info">
                  <div class="track-name">{{ currentPlayback.item.name }}</div>
                  <div class="track-artist" *ngIf="currentPlayback.item.artists && currentPlayback.item.artists.length>0">{{ currentPlayback.item.artists[0].name }}</div>
                  <div class="progress-row">
                    <div style="display:flex;align-items:center;gap:10px;width:100%;">
                      <div style="flex:1;height:8px;background:#172029;border-radius:6px;overflow:hidden;">
                        <div [style.width.%]="getPlaybackPercent()" style="height:100%;background:#1db954;border-radius:6px 0 0 6px;"></div>
                      </div>
                      <div style="min-width:90px;text-align:right;color:#9ca3af;font-size:0.85rem;">
                        {{ formatMs(getProgressMs()) }} / {{ formatMs(getDurationMs()) }}
                      </div>
                    </div>
                  </div>

                  <div class="controls-row" *ngIf="isOwner()">
                    <button class="toggle-ctrl" (click)="togglePlay()">
                      <span *ngIf="currentPlayback?.is_playing; else playIcon">‚è∏</span>
                      <ng-template #playIcon>‚èµ</ng-template>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #noNow>
              <div class="empty-state">No hay reproducci√≥n activa.</div>
            </ng-template>
          </div>

          <div class="section-card devices-card">
            <h4>Dispositivos</h4>
            <div *ngIf="devices && devices.length>0; else noDev">
              <div *ngFor="let d of devices" class="device-item">
                <div style="display:flex; justify-content:space-between; align-items:center">
                  <div>
                    <div class="device-name">{{ d.name }}</div>
                    <div class="device-meta">{{ d.type }} <span *ngIf="d.is_active">‚Ä¢ activo</span></div>
                  </div>
                  <div *ngIf="isOwner()" style="display:flex; gap:8px; align-items:center">
                    <button class="btn-small" (click)="transferTo(d.id, false)">Transferir (sin play)</button>
                    <button class="btn-small primary" (click)="transferTo(d.id, true)">Transferir y reproducir</button>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #noDev>
              <div class="empty-state">No se han detectado dispositivos.</div>
            </ng-template>
          </div>
        </div>

        <div class="section-card queue-card" style="margin-top:18px;">
          <h4>Lista ({{ playlist.length }})</h4>
          <div *ngIf="playlist.length === 0" class="empty-state">La cola est√° vac√≠a üò¥</div>
          <div *ngFor="let item of playlist; let i = index">
            <div class="track queue-item">
              <div class="track-info">
                <div class="track-name" [class.priority-text]="item.createdAt === 0">
                  <span *ngIf="item.createdAt === 0">üöÄ </span>
                  {{ i + 1 }}. {{ item.name }}
                </div>
                <div class="track-artist">{{ item.artist }}</div>
              </div>
              <div class="track-actions">
                <button class="add-btn" (click)="remove(item.id)">Quitar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" *ngIf="showingSettings">
        <h2 class="welcome">Configuraci√≥n</h2>
        <div class="form-group">
            <label>Nombre del Bar</label>
            <input type="text" [(ngModel)]="editData.name">
        </div>
        <div class="form-group">
            <label>Nueva Contrase√±a</label>
            <input type="password" [(ngModel)]="editData.password" placeholder="Dejar en blanco para no cambiar">
        </div>
        <div class="settings-actions">
            <button class="btn-primary" (click)="saveSettings()">Guardar</button>
            <button class="logout-btn" style="border:none" (click)="showingSettings=false">Cancelar</button>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 20px;" *ngIf="!showingSettings">
        <a style="color: #9ca3af; cursor: pointer; font-size: 0.9rem;" (click)="openSettings()">‚öôÔ∏è Configuraci√≥n de cuenta</a>
    </div>

  </div>
</div>

<div class="modal-overlay" *ngIf="showPaymentModal">
  <div class="modal-content payment-modal">
    <h3>üéµ A√±adir a la cola</h3>
    <p>¬øC√≥mo quieres a√±adir <strong>{{ pendingTrack?.name }}</strong>?</p>
    
    <div class="options" style="justify-content:center;">
      <div class="option-card priority" (click)="addPriority()">
        <h4>üöÄ Prioritaria</h4>
        <p class="price">{{ songPrice }} ‚Ç¨</p>
        <small>¬°Se cuela la primera!</small>
      </div>
    </div>

    <button class="close-btn" (click)="closeModal()">Cancelar</button>
  </div>
</div>